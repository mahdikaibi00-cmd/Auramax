<script>
    async function runPostPaymentAI() {
        // 1. Get the data we saved on index.html
        const savedImage = localStorage.getItem('pendingScanImage');
        const userPlan = localStorage.getItem('userPlan');

        if (!savedImage) {
            document.getElementById('summary-display').innerText = "No image found. Please return home and scan again.";
            return;
        }

        try {
            // 2. Call the AI now
            const response = await fetch('/.netlify/functions/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: savedImage, plan: userPlan })
            });

            const data = await response.json();

            // 3. Fill the standard fields
            document.getElementById('shape-display').innerText = data.face_shape;
            document.getElementById('score-display').innerText = "Ready";
            document.getElementById('hair-display').innerText = data.hair;
            document.getElementById('summary-display').innerText = data.top_3_checklist.join(" â€¢ ");

            // 4. If Elite ($29), show the extra advanced sections
            if (userPlan === 'elite') {
                const resultsContainer = document.querySelector('.grid');
                
                // Add Archetype Section
                resultsContainer.innerHTML += `
                    <div class="glass p-6 rounded-2xl border-indigo-500/50 bg-indigo-500/5">
                        <div class="text-indigo-400 text-[10px] font-bold uppercase tracking-widest mb-2">Elite Archetype</div>
                        <div class="text-xl font-bold text-white">${data.archetype}</div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-indigo-500/50 bg-indigo-500/5">
                        <div class="text-indigo-400 text-[10px] font-bold uppercase tracking-widest mb-2">Presence & Confidence</div>
                        <div class="text-sm text-gray-300 leading-relaxed">${data.presence_coaching}</div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-indigo-500/50 bg-indigo-500/5 col-span-full">
                        <div class="text-indigo-400 text-[10px] font-bold uppercase tracking-widest mb-2">Priority Optimization Map</div>
                        <div class="grid md:grid-cols-3 gap-4 mt-4">
                            <div><span class="text-green-400 text-xs font-bold uppercase">Quick Wins:</span><p class="text-xs text-gray-400 mt-1">${data.priority_map.quick_wins.join(", ")}</p></div>
                            <div><span class="text-indigo-400 text-xs font-bold uppercase">Upgrades:</span><p class="text-xs text-gray-400 mt-1">${data.priority_map.medium_upgrades.join(", ")}</p></div>
                            <div><span class="text-red-400 text-xs font-bold uppercase">High Impact:</span><p class="text-xs text-gray-400 mt-1">${data.priority_map.high_effort_high_impact.join(", ")}</p></div>
                        </div>
                    </div>
                `;
            }

        } catch (error) {
            console.error("AI Error:", error);
            document.getElementById('summary-display').innerText = "An error occurred generating your report. Refresh to try again.";
        }
    }

    // Run automatically when the page loads
    window.onload = runPostPaymentAI;
</script>